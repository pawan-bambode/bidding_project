
<%- include('../partials/head') %>
<%- include('../partials/leftSidebar.ejs') %>
<%- include('../partials/header.ejs') %>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-beta.1/css/select2.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-beta.1/js/select2.min.js"></script>

<div class="main-content">
    <div class="breadcrumbs-container">
      <ul class="breadcrumb">
        <% if (breadcrumbs) { %>
            <% for (let crumbs of breadcrumbs) { %>
                <% let crubm_name = crumbs.name == 'ADMIN' ? 'Dashboard' : crumbs.name;
                 %>
                <li><a href="<%- crumbs.url %>"><%- crubm_name %></a></li>
            <% } %>
        <% } %>
    </ul>
    </div>

    <div class="card card-custom-border-curv" >
        <div class="card-header-custom d-flex justify-content-between p-2">
            <h4 class="ms-2">Pre Requisites Data</h4>
            <div>
            <button type="button" class="btn btn-success me-2"  data-bs-target="#upload-pre-requisites-modal" data-bs-toggle="modal">Upload Pre Requisites</button>
            </div>
        </div>
        <div class="card-body table-responsive custom-table">

          <div class="d-flex justify-content-between">
            <div>
                <label>Show Entries</label>
                <select class="form-select" id="changeEntry">
                    <%for(let page of locals.page_filter){%>
                       <option value="<%-page%>"><%-page%></option>
                    <%}%>
                </select>
            </div>
    
            <div>
                <div class="table-searchbar-container"><button type="button"><i class="fas fa-search"></i> </button><input
                    type="search" id="searchkeyword" placeholder="Enter keywords" class="table-searchbar"></div>
            </div>
        </div>
            <table class="table custom_row table-bordered mt-4" id="pre-requisite-table">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Program Name</th>
                    <th>Acad Session</th>
                    <th>Course Name</th>
                    <th>Type</th>
                    <th>Pre-Requisite Course Name</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <% let count = 1 %>
                  <% for(let preRequite of preRequitiesList) { %>
                    <tr>
                      <td><%- count++ %></td>
                      <td><%- preRequite.program_name %></td>
                      <td><%- preRequite.acad_session %></td>
                      <td><%- preRequite.course_name %></td>
                      <td><%- preRequite.type %></td>
                      <td><%- preRequite.pre_req_course_name %></td>
                      <td>
                      <a class="edit-pre-requisite" data-bs-target="#edit-pre-requisite-modal" data-bs-toggle="modal" data-id="<%- preRequite.id %>"
                        data-course-name="<%- preRequite.course_name%>"  data-pre-requites-type="<%- preRequite.type %>" data-pre-requisite-course-name ="<%- preRequite.pre_req_course_name %>"
                        ><i class="fa fa-edit"></i></a>
                      <a data-id="<%- preRequite.id %>" class="delete-pre-requisite" ><i class="fas fa-trash text-danger"></i>
                      </a>
                      </td>
                    </tr>
                    
                  <%}%>
                </tbody>
              </table>
              <div class="d-flex justify-content-between">
                <div>
                    <p>Total entries :&nbsp;<span id="page-no"></span>
                    </p>
                </div>
                <div>
                    <p id="pagination" class="pagination-search"></p>
                </div>
            </div>
        </div>
    </div>
    <div class="modal" id="upload-pre-requisites-modal" data-bs-keyboard="false" data-bs-backdrop="static" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
         
            <div class="modal-header">
              <h5 class="modal-title">Upload Pre Requisites</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <div class="modal-body">
                    <div class="d-flex">
                    <label class="form-label me-3">Import Pre Requisites :</label>
                    <form enctype="multipart/form-data" action="/admin/upload-pre-requisites" method="post" id="upload-pre-requisites-form">
                    <input type="file" name="import-pre-requisites" id="import-pre-requisites" accept=".xlsx">
                    </div>
                    <div class="d-flex justify-content-between align-item-center mt-5">
                    <input type="submit" class="btn btn-success mt-2 d-none" id="upload-pre-requisites-button" value="Upload Pre Requisites"></input> 
                    </form> 
                
                  <a href="/admin/generate-excel-pre-requities" download="sampleForImportPreRequisites.xlsx" name="sample-for-import-course" class="text-decoration-none align-self-end">Sample For Import Pre Requisites</a>
                 </div>
             
            </div>
      
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
           
          </div>
        </div>
      </div>

      <div class="modal" id="edit-pre-requisite-modal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Update Pre Requisites</h3>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <div class="row">
                  <div class="col-md-6">
                  <label class="mb-2 form-label" for="course-name">Course Name:</label>
                  <input type="hidden" id="pre-requisites-id">
                  <input class="form-control" type="text" id="course-name" disabled>
                  <span class="text-danger d-none" id="error-course-name">You Enter Invalid Course Name</span>
                  </div>
                    <div class="col-md-6">
                        <label class="mb-2 form-label" for="pre-requisites-course-name">Pre Requisites Course Name :</label>
                        <input class="form-control" type="text" id="pre-requisites-course-name" disabled>
                    </div>
                    </div>
                    <div class="row">
                      <div class="col-md-6">
                         <label class="mb-2 form-label" for="pre-requisite-type">Pre Requisites Type :</label>
                         <select class="form-control form-select select2 custom-select" id="pre-requisite-type">
                              <option value="1">Exclusive</option>
                              <option value="2">Inclusive</option>
                        </select>
                     
                      </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button class="btn btn-primary" id="update-pre-requisites">Update</button>
                </div>
            </div>
        </div>
    </div>

<script>
   $(document).ready(function(){
    $('.select2').select2();

    let active = `<%- active %>`;
    $('#sidebar .side-menu li.' + active).addClass('active');

    $('#import-pre-requisites').on('change', function(){
        let importPreRequisites = $(this).val();
        if(importPreRequisites != ''){
            $('#upload-pre-requisites-button').removeClass('d-none');
        }
      });
     
      $('#upload-pre-requisites-form').on('submit', function(event) {
        event.preventDefault(); 
        var formData = new FormData(this); 

        $.ajax({
          type: 'POST',
          url: '/admin/pre-requities/upload', 
          data: formData,
          processData: false,
          contentType: false,
          success: function(response) {
            showSuccess(response);
          },
          error: function(xhr, status, error) {
            showError(JSON.stringify(xhr.responseJSON));
          }
        });
      });
      
      $('#pre-requisite-table').on('click','.delete-pre-requisite',function(){
        let id = $(this).attr('data-id');
        
        let ApiObj = {
          type:'POST',
          url:'/admin/pre-requisites/delete',
          data:{
            id:id
          },
          datatype:'JSON'
        }
        ajaxApi(ApiObj).then(result=>{
          $(this).closest('tr').remove();
          showSuccess(result);
        }).catch(error =>{
          showError(JSON.stringify(error.responseJSON));
        })
      })  

      $('#pre-requisite-table').on('click','.edit-pre-requisite',function(){
          let courseName = $(this).attr('data-course-name')
          let preRequisiteCourseName = $(this).attr('data-pre-requisite-course-name');
          let type = $(this).attr('data-pre-requites-type').replace(/\s+/g,' ').trim().toLowerCase();
          let id = $(this).attr('data-id');
          
          $('#edit-pre-requisite-modal #pre-requisites-id').val(id);
          $('#edit-pre-requisite-modal #course-name').val(courseName);
          $('#edit-pre-requisite-modal #pre-requisites-course-name').val(preRequisiteCourseName);
          
          $('#pre-requisite-type option').each(function(index,element){
       
             if(element.textContent.toLowerCase() == type){
              $(element).prop('selected', true);
             }
             else{
              $(element).prop('selected',false);
             }
          })
        })
        $('#edit-pre-requisite-modal').on('show.bs.modal', function (e) {
            $('#pre-requisite-type option').each(function(index,element){
              if(element.textContent.toLowerCase() == $(e.relatedTarget).attr('data-pre-requites-type').toLowerCase()){
                $(element).attr('selected','selected');
                $(element).prop('selected', true);
              }
         })
          
        });
        $('#edit-pre-requisite-modal').on('click','#update-pre-requisites',function(){
            let biddingSessionId = $('#biddingSessionDropdown').attr('data-session-id');
            let id = $('#pre-requisites-id').val();
            let preRequisiteType   = $('#pre-requisite-type option:selected').text();
          
            let editPreRequisites = {
              id : id,
              type:preRequisiteType
            }  
            let ApiObj = {
                type:'POST',
                url:'/admin/pre-requisites/update',
                data: { 
                  editPreRequisites:JSON.stringify(editPreRequisites),
                   biddingSessionId:biddingSessionId
                },
                dataType: 'JSON' 
                }
                ajaxApi(ApiObj).then(result => {
                    showSuccess(result)
                }).catch(error => {
                    showError(JSON.stringify(error.responseJSON))
                })
            
        });
     
    
    $('#changeEntry').on('change',function(){
      let showEntry = $(this).val();
      let ApiObj = {
          type:'POST',
          url:'/admin/pre-requisites/showEntryList',
          data:{
            showEntry:showEntry
          },
          datatype:'JSON'
        }
        ajaxApi(ApiObj).then(result=>{
          paginationData(showEntry,result.length)
            AjaxtTable(result.data)
        }).catch(error =>{
          showError(JSON.stringify(error.responseJSON))
        })    
    })
 
    let test = '<%- pageCount %>';
    let rowCount = $('#changeEntry').val();
    $('#page-no').html(test);
    paginationData(rowCount, parseInt(test));
  
        $('#searchkeyword').on('input',function(){
         let PreRequisiteValue = $(this).val();
         $.ajax({
          type:'POST',
          url:'/admin/pre-requisites/search',
          data:{
            searchLetter:PreRequisiteValue
          },
          success:function(data){
           paginationData(rowCount,data.length)
            AjaxtTable(data.data)
          }
         })
        })
        $(".pagination-search").on('click', '.pagination li', function () {
                let pageNo = $(this).attr('data-lp')
                let searchValue = $(this).val();
                let showEntry = $('#changeEntry').val();
                  $.ajax({
                      type:'POST',
                      url:'/admin/pre-requisites/search',
                      data:{
                        searchLetter:searchValue,
                        pageNo:pageNo,
                        showEntry:showEntry
                      },
                 success:function(data){
                 AjaxtTable(data.data)
          }
         })
        })
        function AjaxtTable(preRequisitesList) {
            
            $("#pre-requisite-table tbody").empty();
            let AjaxTable = ``;
            if (preRequisitesList.length > 0) {
                let count = 1;
                for (preRequisites of preRequisitesList) {
                    AjaxTable +=
                        `<tr>
                            <td>${count++}</td>
                            <td>${preRequisites.program_name}</td>
                            <td>${preRequisites.acad_session}</td>
                            <td>${preRequisites.course_name}</td>
                            <td>${preRequisites.type}</td>
                            <td>${preRequisites.pre_req_course_name}</td>
                            <td>
                              <a class="edit-pre-requisite" data-bs-target="#edit-pre-requisite-modal" data-bs-toggle="modal" data-id="${preRequisites.id}"
                                 data-course-name="${preRequisites.course_name}"  data-pre-requites-type="${preRequisites.type}"> 
                                  <i class="fa fa-edit"></i>
                                </a>
                                <a data-id="${preRequisites.id}" class="delete-course">
                                    <i class="fas fa-trash text-danger"></i>
                                </a>
                                
                            </td>
                        </tr>`
                }
            }       
            $("#pre-requisite-table tbody").html(AjaxTable);
        }
   })

</script>
<%- include('../partials/footer.ejs') %>
<%- include('../partials/footerEnd.ejs') %>

