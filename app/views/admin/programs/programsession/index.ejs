<%- include('../../partials/head') %>
<%- include('../../partials/leftSidebar.ejs') %>
<%- include('../../partials/header.ejs') %>

<div class="main-content">
    <div class="breadcrumbs-container">
        <ul class="breadcrumb">
            <% if (breadcrumbs) { %>
                <% for (let crumbs of breadcrumbs) { %>
                    <% let crubm_name = crumbs.name == 'ADMIN' ? 'Dashboard' : crumbs.name;
                     %>
                    <li><a href="<%- crumbs.url %>"><%- crubm_name %></a></li>
                <% } %>
            <% } %>
        </ul>
    </div>
  <div class="card card-custom-border-curv">
    <div class="card-header-custom d-flex justify-content-between p-1">
        <h3 class="ms-2">Program Sessions List</h3>
        <button type="button" class="btn btn-danger ms-auto me-3"  id="refresh-program-sessions">
            <i class="fa-solid fa-rotate p-1"></i>Refresh
        </button>  
    </div>
    <div class="card-body table-responsive">
        <div class="d-flex justify-content-between">
            <div>
                <label>Show Entries</label>
                <select class="form-select" id="changeEntry">
                    <% for (let page of locals.page_filter) { %>
                        <option value="<%- page %>"><%- page %></option>
                    <% } %>
                </select>
            </div>
            <div>
                <div class="table-searchbar-container d-flex justify-content-around p-1">
                    <button type="button" id="searchkeyword-button" class="border-0 outline-0">
                        <i class="fas fa-search"></i>
                    </button>
                    <input type="search" id="searchkeyword" placeholder="Enter keywords" class="table-searchbar" autocomplete="off" size="24">
                </div>
            </div>
        </div>

        <table class="table custom_row table-bordered mt-4 custom-table" id="program-sessions-table">
            <thead>
                <th>#</th>
                <th>Acad Session</th>
                <th>Program Name</th>
                <th>Year</th>
                <th>Minimum Credits</th>
                <th>Maximum Credits</th>
                <th>Action</th>
            </thead>
            <tbody>
                <% let count = 1 %>
                <%for(let programSession of programSessionList) { %>
                    <tr>
                        <td><%- count++ %></td>
                        <td><%-programSession.acad_session %></td>
                        <td><%-programSession.program_name %></td>
                        <td><%-programSession.year %></td>
                        <td><%-programSession.min_credits %></td>
                        <td><%-programSession.max_credits %></td>
                        <td><a class="edit-program-sessions" data-bs-target="#edit-program-sessions" data-bs-toggle="modal" data-id="<%-programSession.id %>" data-min-credits ="<%- programSession.min_credits %>"
                            data-max-credits ="<%- programSession.max_credits %>"
                        data-acad-session = "<%- programSession.acad_session %>"
                            ><i class="fa fa-edit"></i></a>
                            
                        </td>
                    </tr>
                <%}%>
            </tbody>
        </table>
        <div class="d-flex justify-content-between">
            <div>
                <p>Total entries :&nbsp;<span id="page-no"></span>
                </p>
            </div>
            <div>
                <p id="pagination" class="pagination-search"></p>
            </div>
        </div>
    </div>
  </div>  
</div>


<div class="modal" id="edit-program-sessions" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Acad Session Credits</h5>
                <button class="btn-close modal-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label for="acad-session-disabled">Acad Session:</label>
                <input type="text" id="acad-session-disabled" class="form-control" autocomplete="off" disabled><br>

                <div class="empty">
                    <input type="hidden" id="program-session-id">
                    <label class="form-label" for="min-credits">Minimum Credits:</label>
                    <input class="form-control is-empty is-number" type="text" id="min-credits" autocomplete="off">
                    <span class="text-danger d-none is-in-valid"></span><br>
                </div>

                <div class="empty">
                    <label class="form-label" for="max-credits">Maximum Credits:</label>
                    <input class="form-control is-empty is-number" type="text" id="max-credits" autocomplete="off">
                    <span class="text-danger d-none is-in-valid"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary modal-close" data-bs-dismiss="modal">Close</button>
                <button class="btn btn-primary" id="update-program-sessions">Update</button>
            </div>
        </div>
    </div>
</div>

<%- include('../../partials/footer.ejs') %>
<script>
    $(document).ready(function() {
        let test = '<%- pageCount %>';
        let rowCount = $('#changeEntry').val();
        $('#page-no').html(test);
        
        setActiveMenuItem(`<%- active %>`)

        paginationData(rowCount, parseInt(test));
    
     $('#refresh-program-sessions').on('click',function(){
        let ApiObj = {
            url:'/admin/program-session/refresh',
            type:'POST',
            data:{},
            datatype:'JSON'
        }
        ajaxApi(ApiObj).then(result=>{
            createToastMessage(result.description);
        }).catch(error =>{
            createToastError(JSON.stringify(error.responseJSON.description));
        })
     })




     $('#update-program-sessions').on('click',function(){
        let maxCredits = $('#edit-program-sessions #max-credits').val();
        let minCredits = $('#edit-program-sessions #min-credits').val();
        let programSessionId = $('#edit-program-sessions #program-session-id').val();


        let isRequiredFieldsEmpty = isModalFieldEmpty('#edit-program-sessions .modal-body');
         
            if(isRequiredFieldsEmpty){
         
        let ApiObj = {
            url:'/admin/program-session/update',
            type:'POST',
            data:{
                id:programSessionId,
                min_credits:minCredits,
                max_credits:maxCredits
            },
            datatype:'JSON'
        }
        ajaxApi(ApiObj).then(result =>{
            createToastMessage(result.description);
        }).catch(error =>{
            createToastError(JSON.stringify(error.responseJSON.description));;
        })
    }
    })   

    $('#edit-program-sessions').on('click', '.modal-close', function() {
        $(this).closest('.modal-content').find(`.is-in-valid`).addClass('d-none');
    });

    $('#program-sessions-table').on('click','.edit-program-sessions',function(){
        let minCredits = $(this).data('min-credits');
        let maxCredits = $(this).data('max-credits');
        let acadSession = $(this).data('acad-session');

       let programSessionId = $(this).closest('a').attr('data-id');
       $('#edit-program-sessions #program-session-id').val(programSessionId);
       $('#edit-program-sessions #min-credits').val(minCredits);
       $('#edit-program-sessions #max-credits').val(maxCredits);
       $('#edit-program-sessions #acad-session-disabled').val(acadSession);
    })
    $('#searchkeyword').on('input',function(){

        let searchValue = $(this).val().trim();
        let showEntry = $('#changeEntry').val();
    
            
            $.ajax({
            type:'POST',
            url:'/admin/program-sessions/search',
            data:{
            searchLetter:searchValue,
            showEntry:showEntry
            },
            success:function(data){
            paginationData(rowCount,data.length)
            AjaxtTable(data.programSessionList );
            $('#page-no').html(data.length);
            }
            })
        })       

$(".pagination-search").on('click','.pagination li',function(){
    let keyword = $("#searchkeyword").val();
    let showEntry = $('#changeEntry').val();
    let pageNo = $(this).attr('data-lp');
 
    $.ajax({
        type: "POST",
        url: "/admin/program-sessions/search",
        data: {
            searchLetter: keyword,
            pageNo: pageNo,
            showEntry:showEntry
        },
        success: function (data) {
            AjaxtTable(data.programSessionList);
            paginationData(showEntry,data.length)
            $('#page-no').html(data.length);
        }
    });
});

$('#changeEntry').on('change',function(){
let showEntry = $(this).val();
let ApiObj = {
    type:'POST',
    url:'/admin/program-sessions/showEntry',
    data:{
        showEntry:showEntry
    },
    datatype:'JSON'
    }
    ajaxApi(ApiObj).then(result=>{
    paginationData(showEntry,result.length)
    AjaxtTable(result.programSessionList)
    $('#page-no').html(result.length)
    $('#searchkeyword').val('');
    }).catch(error =>{
    createToastError(JSON.stringify(error.responseJSON.description));;
    })    
})

       
});

            function AjaxtTable(programSessionList) {
           $("#program-sessions-table tbody").empty();
           let AjaxTable = ``;
           if (programSessionList.length > 0) {
               let count = 1;
               for (programSession of programSessionList) {
                   AjaxTable +=
                       `<tr>
                           <td>${count++}</td>
                           <td>${programSession.acad_session}</td>
                           <td>${programSession.program_name}</td>
                           <td>${programSession.year}</td>
                           <td>${programSession.min_credits}</td>
                           <td>${programSession.max_credits}</td>
                           <td>
                               <a class="edit-program-sessions" data-bs-target="#edit-program-sessions" data-bs-toggle="modal"
                               data-min-credits ="${programSession.min_credits}"
                               data-max-credits ="${programSession.max_credits}"
                               data-acad-session = "${programSession.acad_session}"
                               data-id="${programSession.id}">
                           <i class="fa fa-edit"></i></a>
                           
                           </td>
                       </tr>`
               }
           }
                
           $("#program-sessions-table tbody").html(AjaxTable);
       }
</script>
  
<%- include('../../partials/footerEnd.ejs') %>